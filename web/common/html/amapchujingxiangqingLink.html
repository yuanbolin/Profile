<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
	<title>轨迹回放</title>
	<script type="text/javascript" src="../jquery.min.js"></script>
	<script type="text/javascript" src="../layer.js"></script>
	<script type="text/javascript" src="../common.js"></script>
	<script type="text/javascript" src="../moment.js"></script>

	<link rel="stylesheet" type="text/css" href="../theme/default/lis.css" />
	<link rel="stylesheet" type="text/css" href="../theme/default/gis.css" />
	<link rel="stylesheet" type="text/css" href="../theme/default/style.css" />
	<link rel="stylesheet" type="text/css" href="../theme/default/H-ui.min.css" />
	<link rel="stylesheet" type="text/css" href="../theme/default/H-ui.reset.css" />
	<style type="text/css">
		#container {
			width: 100%;
			height: 100%;
			margin: 0px;
		}
		.map {
			width: 99%;
			height: 97%;
			float: left;
			position: relative;
			border-width: 1px;
			border-style: solid;
			border-color: rgb(210, 210, 210);
			border-image: initial;
			margin: 8px;
			overflow: hidden;
		}
		.select_cont input {
			width: 45%;
			margin: 10px;
		}
		.select_cont button {
			width: 28%;
		}
	</style>
</head>

<body>
<div class="map">
	<h3>
		<img src="../../imgs/icon_clxsgj.png">车辆行驶轨迹
	</h3>

	<div id="container"></div>
	<script type="text/javascript" src='//webapi.amap.com/maps?v=1.4.9&key=4e1808829fb90fb841c9352870fdae9f'></script>
	<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	<script type="text/javascript">
		var chepaihaoma;
		var paichekaishishijian;
		var paichejieshushijian;
		$(document).ready(function() {
			startRun();
			update();
		});
		let ditujingdu;
		let dituweidu;
		var jigoumingcheng = sessionStorage.getItem("jigoumingcheng");
		$.ajax({
			url:SERVER+"zuzhijigouXiangqingJgmc?jigoumingcheng="+jigoumingcheng,
			async:false,
			success:function(data) {
				if (data.data['jingdu'] != 0 && data.data['weidu'] != 0 && data.data['dianziweilanbanjing'] != 0) {
					ditujingdu = data.data['jingdu'];
					dituweidu = data.data['weidu'];
				}
			}
		});
		//创建地图
		var map = new AMap.Map('container', {
			//TODO 地图缩放比例待定，根据测试数据调整
			resizeEnable: true,
			center:[ditujingdu,dituweidu],
			zoom: 15,
			showIndoorMap: false,
			zooms:[8,19]
		});

		var mybounds = new AMap.Bounds([ditujingdu-4, dituweidu-2], [ditujingdu+4, dituweidu+2]);
		map.setBounds(mybounds);
		var bounds = map.getBounds();
		map.setLimitBounds(bounds);

		var navg1 = null;

		function startRun(starttime, endtime) {
			let id = GetQueryString("id");
			if (navg1 != null) {
				navg1.destroy();
			}
			$.ajax({
				type: "get",
				url: SERVER + "huoqumouliangchexingshiguiji?id="+id,
				async: false,
				data : JSON.stringify(),
				dataType : 'json',
				contentType : "application/json",
				success: function(data) {
					if (data.data == null || data.data.length == 0) {
						alert('当前路径为空');
					} else {
						//绘制轨迹
						if (window.pathSimplifierIns) {
							//通过该方法清空上次传入的轨迹
							pathSimplifierIns.setData([]);
						}
						AMapUI.load(['ui/misc/PathSimplifier', 'lib/$'], function(PathSimplifier, $) {
							if (!PathSimplifier.supportCanvas) {
								alert('当前环境不支持 Canvas，无法显示轨迹图，建议使用Google浏览器预览');
								return;
							}
							var pathSimplifierIns = new PathSimplifier({
								zIndex: 100,
								//autoSetFitView:false,
								map: map, //所属的地图实例
								getPath: function(pathData, pathIndex) {
									return pathData.path;
								},
								getHoverTitle: function(pathData, pathIndex, pointIndex) {
									if (pointIndex >= 0) {
										//point
										return pathData.name + '，点：' + pointIndex + '/' + pathData.path.length;
									}
									return pathData.name + '，点数量' + pathData.path.length;
								},
								renderOptions: {
									renderAllPointsIfNumberBelow: -1 //绘制路线节点，如不需要可设置为-1
								}
							});
							pathSimplifierIns.clearPathNavigators();
							window.pathSimplifierIns = pathSimplifierIns;
							//设置数据
							pathSimplifierIns.setData([{
								name: '消防车轨迹',
								path: data.data,
							}]);
							//对第一条线路（即索引 0）创建一个巡航器
							navg1 = pathSimplifierIns.createPathNavigator(0, {
								loop: false, //不循环播放
								//TODO 轨迹移动速度待定，根据测试数据调整
								speed: 1000 //巡航速度，单位千米/小时
							});
							navg1.start();
						});
					}
				}
			});
		}

    function GetQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) {
        return decodeURI(r[2]);
      }
      return null;
    }


  </script>

</div>
<script type="text/javascript" src="../WdatePicker.js" charset="utf-8"></script>
<script type="text/javascript">

</script>

</body>

</html>
