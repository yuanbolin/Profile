<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>点聚合</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
  <link rel="stylesheet" type="text/css" href="../../themes/default/easyui.css">
  <script
    src="https://webapi.amap.com/maps?v=2.0&key=4e1808829fb90fb841c9352870fdae9f&plugin=AMap.MarkerCluster,AMap.ControlBar,AMap.ToolBar,AMap.PolygonEditor"></script>

  <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
  <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css"/>
  <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
  <script type="text/javascript" src="../jquery.min.js"></script>
  <script type="text/javascript" src="../layer.js"></script>
  <script type="text/javascript" src="../common.js"></script>
  <script type="text/javascript" src="../moment.js"></script>
  <script type="text/javascript" src="../js/jquery.ztree.all-3.5.min.js"></script>

  <!--    <link rel="stylesheet" type="text/css" href="../theme/default/gis.css"/>-->
  <link rel="stylesheet" type="text/css" href="../theme/default/style.css"/>
  <link rel="stylesheet" type="text/css" href="../theme/default/H-ui.min.css"/>
  <link rel="stylesheet" type="text/css" href="../theme/default/H-ui.reset.css"/>
  <link rel="stylesheet" type="text/css" href="../css/zTreeStyle.css"/>
  <link rel="stylesheet" href="../js/bootstrap-3.3.7-dist/css/bootstrap.min.css">
  <style type="text/css">
    .clxx_box {
      width: 100%;
      height: 60px;
    }

    .BMap_bubble_content .aaa {
      color: blue;
      font-weight: 600;
      margin-bottom: 9px;
    }

    .detail_box {
      height: 70px;
    }

    .szxx_box {
      height: 70px;
    }

    .detail_box table td, .szxx_box table td {
      border: 1px solid #ddd;
      padding: 3px 0;
    }

    .detail_box table td.blue {
      color: blue;
      min-width: 18px !important;
    }

    .bor_none {
      border: none !important;
    }

    .szxx_box table td.blue {
      color: #ff8800;
      min-width: 18px !important;
    }

    table td, table th {
      text-align: center !important;
    }

    table {
      width: 100%;
      empty-cells: show;
      background-color: transparent;
      border-collapse: collapse;
      border-spacing: 0;
    }

    tbody {
      display: table-row-group;
      vertical-align: middle;
      border-color: inherit;
    }

    tr {
      display: table-row;
      vertical-align: inherit;
      border-color: inherit;
    }

    .aaa {
      text-align: center;
    }

    .aaa a {
      display: inline-block;
      width: 120px;
      height: 32px;
      line-height: 32px;
      color: #fff !important;
      background: #63c163;
      border-radius: 8px;
      text-decoration: none !important;
    }

    .aaa a:nth-child(1) {
      margin-right: 20px;
    }

    .ztree {
      height: calc(100% - 30px);
      overflow-y: auto;
    }

    #up-map-div {
      width: 310px;
      height: 249px;
      top: 10px;
      right: 10px;
      position: absolute;
      z-index: 9999;
      border: 1px solid blue;
      font-size: 22px
    }

    .table td {
      color: black;
      background-color: #4c8bfd;
      text-align: left;
      font-size: 18px
    }

    .panel-title {
      margin-top: 0px;
      margin-bottom: 0px;
      font-size: 16px;
      color: inherit;
      text-align: center;
    }

    .mapMain {
      position: absolute;
      width: 98%;
      min-height: 100%;
      max-height: 100%;
      height: auto;
    }

    .input-card {
      width: 47%;
      top: 5px;
      left: 34.9%;
      bottom: auto;
      padding: 0;
      height: 40px;
    }

    ul li {
      float: left;
      line-height: 40px;
      text-align: center;
      width: 100px;
    }

    .input-card ul li:hover {
      /*color: #F00;*/
      background-color: #ccc;
      cursor: pointer;
    }

    .tuceng_item li {
      background-color: #eee;
    }

    .xiaofangche_item li {
      background-color: #eee;
    }

    .jingqing_item li {
      background-color: #eee;
    }

    .shuiyuan_item li {
      background-color: #eee;
    }

    .danwei_item li {
      background-color: #eee;
    }

    .tuceng_item {
      display: none;
    }

    .sousuo_item {
      display: none;
    }

    .gongju_item {
      display: none;
    }

    .xiaofangche_item {
      display: none;
    }

    .jingqing_item {
      display: none;
    }

    .shuiyuan_item {
      display: none;
    }

    .danwei_item {
      display: none;
    }

    .sousuo_item li input {
      width: 100px;
    }


    .changebtn {
      width: 46.2%;
      height: 30px;
      align-items: center;
      justify-content: center;
      background-color: #3b5a9b;
      color: #fff;
      border: none;
    }

    .tab {
       margin-top: 20px;
      width: 160px;
      line-height: 60px;
      text-align: center;
    }

    .tab1 {
      background-color: yellow;
    }

    .tab3 {
       background-color: green;
    }


    .map_right {
      border: 1px solid #ddd;
      height: 94%;
      width: 15.5%;
      position: absolute;
      top: 5px;
      left: 83.5%;
      background: #2f3c62;
      z-index: 9999;
    }

    .map_right .tit {
      background: #3b5a9b;
      text-align: center;
      font-size: 14px;
      display: inline-block;
      width: 100%;
    }

    #map {
      height: calc(100% - 6px);
      width: 100%;
      position: absolute;
      backgrouond: #fff;
      border: 1px solid #d2d2d2;
      top: 5px;
      right: 0%;
      bottom: 60px;
    }

    .map_left {
      border: 1px solid #ddd;
      /*height: 94%;*/
      width: 180px;
      position: absolute;
      top: 5.2%;
      left: 71.8%;
      background: #fff;
    }

    .map_left .tit {
      background: #f9ecec;
      text-align: center;
      font-size: 14px;
      line-height: 30px;
    }

    .amap-toolbar {
      right: 96.8% !important;;
      left: 20px !important;
      bottom: 20px !important;
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 0 3px rgba(0, 0, 0, .5);
    }
  </style>
</head>

<body>
<div id="mapMain" class="mapMain">
  <div id="map"></div>

  <!-- 头部工具栏-->
  <div class='input-card'>
    <ul>
      <li class="tuceng"><a href="#">图层选择</a>
        <ul class="tuceng_item">
          <li><input type="checkbox" checked onclick="toggleSatelliteLayer(this)"/>卫星图层</li>
          <li><input type="checkbox" checked onclick="toggleRoadNetLayer(this)"/>路网图层</li>
          <li><input type="checkbox" checked onclick="toggleTrafficLayer(this)"/>实时交通图层</li>
        </ul>
      </li>
<!--      <li class="sousuo" onclick="sousuo()"><a href="#">搜索</a>-->
<!--        <ul class="sousuo_item">-->
<!--          <li><input id="sousuotiaojian"/></li>-->
<!--        </ul>-->
<!--      </li>-->
      <li class="gongju"><a href="#">工具</a>
        <ul class="gongju_item">
          <li>
            <button class="btn" onclick="createPolygon()">选择区域</button>
          </li>
          <li>
            <button class="btn" onclick="quxiaoxuanze()">取消选择</button>
          </li>
          <li>
            <button class="btn" onclick="shujutongji()">数据统计</button>
          </li>
        </ul>
      </li>
      <li class="xiaofangche"><a href="#">消防车</a>
        <ul class="xiaofangche_item">
          <li><input type="checkbox" checked onclick="xiaofangchechanxun(this,'出动')"/>出动</li>
          <li><input type="checkbox" checked onclick="xiaofangchechanxun(this,'待命')"/>待命</li>
          <li><input type="checkbox" checked onclick="xiaofangchechanxun(this,'报废')"/>报废</li>
        </ul>
      </li>
      <li class="jingqing"><a href="#">警情</a>
        <ul class="jingqing_item">
          <li><input type="checkbox" checked onclick="jingqingchanxun(this,'火灾扑救')"/>火灾扑救</li>
          <li><input type="checkbox" checked onclick="jingqingchanxun(this,'抢险救援')"/>抢险救援</li>
          <li><input type="checkbox" checked onclick="jingqingchanxun(this,'抢险救援')"/>抢险救援</li>
          <li><input type="checkbox" checked onclick="jingqingchanxun(this,'其他')"/>其他</li>
        </ul>
      </li>
      <li class="shuiyuan"><a href="#">水源</a>
        <ul class="shuiyuan_item">
          <li><input type="checkbox" checked onclick="shuiyuanchanxun(this,'消火栓')"/>消火栓&#12288;</li>
          <li><input type="checkbox" checked onclick="shuiyuanchanxun(this,'水鹤')"/>消防水鹤</li>
          <li><input type="checkbox" checked onclick="shuiyuanchanxun(this,'水池')"/>消防水池</li>
          <li><input type="checkbox" checked onclick="shuiyuanchanxun(this,'取水码头')"/>取水码头</li>
        </ul>
      </li>
      <li class="danwei"><a href="#">重点单位</a>
        <ul class="danwei_item">
          <li><input type="checkbox" checked onclick="zhongdiandanweichanxun(this,'易燃易爆场所')"/>易燃易爆场所</li>
          <li><input type="checkbox" checked onclick="zhongdiandanweichanxun(this,'高层')"/>高层</li>
          <li><input type="checkbox" checked onclick="zhongdiandanweichanxun(this,'地下')"/>地下</li>
          <li><input type="checkbox" checked onclick="zhongdiandanweichanxun(this,'人员密集场所')"/>人员密集场所</li>
          <li><input type="checkbox" checked onclick="zhongdiandanweichanxun(this,'重要场所')"/>重要场所</li>
        </ul>
      </li>
      <li class="jigouchanxun" style="width: 180px"><a href="#">机构查询</a>
      </li>
<!--      <li class="quanbing"><a href="#">全屏</a>-->
<!--      </li>-->
    </ul>
  </div>
  <!--    左侧机构列表，默认不显示-->
  <div class="map_left" style="display: none">
    <div class="tit">机构列表</div>
    <ul id="treeDemo" class="ztree"></ul>
  </div>
  <!--    右侧统计信息-->
  <button onclick="xianshi()" style="float: right;height: 32px;width: 30px;margin-top: 3%;margin-right: 0.5%;"><span
    class="glyphicon glyphicon-backward" aria-hidden="true"></span></button>
  <div class="map_right" style="display:none;">
    <div class="tit">
            <span style="float: left;margin-top: 8px" onclick="yicang()" class="glyphicon glyphicon-triangle-right"
                  aria-hidden="true"></span>
      <button class="changebtn">消防车统计</button>
      <button class="changebtn">装备统计</button>
    </div>
    <div class="tab">
      <span style="display: block;width: 255px;background: #1d253f;color:white">消防车统计</span>
    </div>

    <div class="tab tab3">
      <span style="display: block;width: 255px;background: #1d253f;color:white">装备器材统计</span>

    </div>
  </div>
</div>

<script>
    //控制统计信息tab页
    var btns = $(".changebtn");
    var tabs = $(".tab");
    for (var i = 0; i < btns.length; i++) {
        var btn = btns[i];
        btn.index = i;
        for (var k = 0; k < tabs.length; k++) {
            tabs[k].style.display = 'none';
        }
        btn.onclick = function () {
            for (var j = 0; j < tabs.length; j++) {
                var oo = tabs[j];
                tabs.currentIndex = j;
            }
            tabs.css('display', 'none');
            tabs[this.index].style.display = 'block';
            btns.css('background', '#3b5a9b');
            btns[this.index].style.background = '#081832';
        }
    }
    tabs[0].style.display = 'block';


    //工具栏下拉菜单控制
    $('.tuceng').hover(function () {
        $(".tuceng_item").css('display', 'block');
    }, function () {
        $(".tuceng_item").css('display', 'none');
    });
    $('.sousuo').hover(function () {
        $(".sousuo_item").css('display', 'block');
    }, function () {
        $(".sousuo_item").css('display', 'none');
    });
    $('.gongju').hover(function () {
        $(".gongju_item").css('display', 'block');
    }, function () {
        $(".gongju_item").css('display', 'none');
    });
    $('.xiaofangche').hover(function () {
        $(".xiaofangche_item").css('display', 'block');
    }, function () {
        $(".xiaofangche_item").css('display', 'none');
    });
    $('.jingqing').hover(function () {
        $(".jingqing_item").css('display', 'block');
    }, function () {
        $(".jingqing_item").css('display', 'none');
    });
    $('.shuiyuan').hover(function () {
        $(".shuiyuan_item").css('display', 'block');
    }, function () {
        $(".shuiyuan_item").css('display', 'none');
    });
    $('.danwei').hover(function () {
        $(".danwei_item").css('display', 'block');
    }, function () {
        $(".danwei_item").css('display', 'none');
    });
    $('.jigouchanxun').hover(function () {
        $(".map_left").css('display', 'block');
    }, function () {
        $(".map_left").css('display', 'none');
    });
    $('.map_left').hover(function () {
        $(".map_left").css('display', 'block');
    }, function () {
        $(".map_left").css('display', 'none');
    });

    //统计信息收缩
    function yicang() {
        $(".map_right").css('display', 'none');
    }

    function xianshi() {
        $(".map_right").css('display', 'block');
    }

    //左侧机构列表收缩
    function kongzhishu() {
        var display = $(".map_left")[0].style.display;
        if (display === 'none') {
            $(".map_left").css('display', 'block');
        } else {
            $(".map_left").css('display', 'none');
        }
    }

    //搜索消防车方法
    function sousuo() {
        // var sousuotiaojian = $("#sousuotiaojian").val().trim();
        // console.log(sousuotiaojian);
        // var points = {
        //     cheliangleixing: "举高喷射消防车",
        //     chepaihaoma: "鲁X6894应急",
        //     chujingzhuangtai: "在营",
        //     id: 41,
        //     jingdu: 116.416504,
        //     shifoushenyangsuocheliang: null,
        //     suoshujigou: "战保大队",
        //     weidu: 37.432672,
        //     weizhishijian: "2020-03-17T08:31:20.597Z",
        //     xiaofangcheleixing: "举高喷射消防车",
        //     xiaofangchezhuangtai: "正常",
        // }
        // var markerjwd = [points.jingdu, points.weidu];
        // map.setCenter([points.jingdu, points.weidu]);
        // infoWindow = new AMap.InfoWindow({
        //     isCustom: false,
        //     //	        offset: new AMap.Pixel(0, -31),
        //     content: ""
        // });
        // infoWindow.setContent(
        //     "<div style='box-sizing: content-box; width: 300px; height: 120px; position: static; left: 16px; top: 16px; z-index: 10; overflow: hidden;'>"
        //     + "<div class='BMap_bubble_title' style='display: none; overflow: hidden; height: auto; line-height: 24px; white-space: nowrap; width: auto;'></div>"
        //     + "<div class='BMap_bubble_content' style='width: auto; height: auto;'>"
        //     + "<div class='clxx_box'>"
        //     + "<span>车牌号码：</span>"
        //     + "<span>" + points.chepaihaoma + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
        //     + "<span>车辆类型：</span>"
        //     + "<span>" + points.cheliangleixing + "</span> &nbsp;&nbsp;&nbsp;&nbsp;"
        //     + "<br/>"
        //     + "<span>所属机构：</span>"
        //     + "<span>" + points.suoshujigou + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
        //     + "<span>出警状态：</span>"
        //     + "<span>" + points.chujingzhuangtai + "</span> &nbsp;&nbsp;&nbsp;&nbsp;"
        //     + "<br/>"
        //     + "<span>消防车状态：</span>"
        //     + "<span>" + points.xiaofangchezhuangtai + "</span>"
        //     + "</div>"
        //     + "<div class='aaa'>"
        //     + "<span style='color:#429842'>位置时间：</span>"
        //     + "<span style='color:#429842'>" + moment(points.weizhishijian).format('YYYY-MM-DD HH:mm:ss') + "</span>"
        //     + "</div>"
        //     + "<div class='aaa'>"
        //     + "<a style='color:blue' onclick='openMessage2(\"" + points.chepaihaoma + "\")'>轨迹信息</a>"
        //     + "</div>"
        //     + "</div>"
        //     + "</div>"
        // );
        // infoWindow.open(map, markerjwd);
    }

    //机构列表数变量
    var treeObj;
    var setting = {
        view: {
            dblClickExpand: false,
            showLine: true,
            selectedMulti: false
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pId",
                rootPId: ""
            }
        },
        check: {
            autoCheckTrigger: false,
            enable: true,
            chkStyle: "checkbox",
            chkboxType: {"Y": "", "N": ""}
        },

        callback: {
            // beforeClick: zTreeBeforeClick,
            onCheck: zTreeOnCheck,
        }
    };


    //选择机构List
    var jigoudaimaiList = [];

    function zTreeOnCheck(event, treeId, treeNode) {
        if (treeNode.checked === true) {
            jigoudaimaiList.push(treeNode.id)
        } else {
            var index = jigoudaimaiList.indexOf(treeNode.id);
            if (index !== null && index !== undefined) {
                jigoudaimaiList.splice(index, 1);
            }
        }
        getDitu();
    }

    //消防车位置list
    var points = [];
    var xiaofangcheleixing = ['出动', '待命', '报废'];
    function xiaofangchechanxun(checkbox, chaxuntiaojian) {
        if (checkbox.checked) {
            xiaofangcheleixing.push(chaxuntiaojian)
        } else {
            var index = xiaofangcheleixing.indexOf(chaxuntiaojian);
            if (index !== null && index !== undefined) {
                xiaofangcheleixing.splice(index, 1);
            }
        }
        getXiaofangche();
    }
    //重点单位位置list
    var zhongdiandanweipoints = [];
    var zhongdiandanweileixing = ['易燃易爆场所', '高层', '地下', '人员密集场所', '重要场所'];

    function zhongdiandanweichanxun(checkbox, chaxuntiaojian) {
        if (checkbox.checked) {
            zhongdiandanweileixing.push(chaxuntiaojian)
        } else {
            var index = zhongdiandanweileixing.indexOf(chaxuntiaojian);
            if (index !== null && index !== undefined) {
                zhongdiandanweileixing.splice(index, 1);
            }
        }
        getDanWei();
    }

    //警勤位置list
    var jingqingpoints = [];
    var jingqingleixing = ['火灾扑救', '抢险救援', '社会救助', '其他'];

    function jingqingchanxun(checkbox, chaxuntiaojian) {
        if (checkbox.checked) {
            jingqingleixing.push(chaxuntiaojian)
        } else {
            var index = jingqingleixing.indexOf(chaxuntiaojian);
            if (index !== null && index !== undefined) {
                jingqingleixing.splice(index, 1);
            }
        }
        getJingqing();
    }
    //水源位置list
    var shuiyuanpoints = [];
    var shuiyuanleixing = ['消火栓', '水鹤', '水池', '取水码头'];
    function shuiyuanchanxun(checkbox, chaxuntiaojian) {
        if (checkbox.checked) {
            shuiyuanleixing.push(chaxuntiaojian)
        } else {
            var index = shuiyuanleixing.indexOf(chaxuntiaojian);
            if (index !== null && index !== undefined) {
                shuiyuanleixing.splice(index, 1);
            }
        }
        getShuiyuan();
    }
    //点聚合
    var cluster;

    var zhongdiandanweicluster;

    var jingqingcluster;

    var shuiyuancluster;

    //地图
    var map;
    $(document).ready(function () {
        //电子围栏
        getDianziweilan();
        //组织机构树
        zTreeReady();
    });

    //地图中心设置为当前组织机构经纬度
    let ditujingdu;
    let dituweidu;
    let diaoyong = '二次调用';
    var jigoumingcheng = sessionStorage.getItem("jigoumingcheng");
    $.ajax({
        url: SERVER + "zuzhijigouXiangqingJgmc?jigoumingcheng=" + jigoumingcheng + "&diaoyong=" + diaoyong,
        async: false,
        success: function (data) {
            if (data.data['jingdu'] != 0 && data.data['weidu'] != 0 && data.data['dianziweilanbanjing'] != 0) {
                ditujingdu = data.data['jingdu'];
                dituweidu = data.data['weidu'];
            }
        }
    });

    //3D地图
    map = new AMap.Map('map', {
        rotateEnable: true,
        pitchEnable: true,
        zoom: 17,
        pitch: 50,
        rotation: -15,
        viewMode: '3D', //开启3D视图,默认为关闭
        zooms: [8, 20],
        center: [ditujingdu, dituweidu],
    });

    //3D盘
    var controlBar = new AMap.ControlBar({
        position: {
            left: '10px',
            top: '10px'
        }
    });
    controlBar.addTo(map);

    //卫星图层
    var SatelliteLayer = new AMap.TileLayer.Satellite({
        zIndex: 10
    });

    SatelliteLayer.setMap(map);


    function toggleSatelliteLayer(checkbox) {
        if (checkbox.checked) {
            SatelliteLayer.show();
        } else {
            SatelliteLayer.hide();
        }
    }

    //路网图层
    var RoadNetLayer = new AMap.TileLayer.RoadNet({
        zIndex: 10
    });

    RoadNetLayer.setMap(map);


    function toggleRoadNetLayer(checkbox) {
        if (checkbox.checked) {
            RoadNetLayer.show();
        } else {
            RoadNetLayer.hide();
        }
    }

    //实时交通图层
    var TrafficLayer = new AMap.TileLayer.Traffic({
        zIndex: 10
    });

    TrafficLayer.setMap(map);


    function toggleTrafficLayer(checkbox) {
        if (checkbox.checked) {
            TrafficLayer.show();
        } else {
            TrafficLayer.hide();
        }
    }

    //多边形选中区域
    var polygon;
    var polyEditor = new AMap.PolygonEditor(map);
    polyEditor.on('add', function (data) {
        polygon = data.target;
        polyEditor.addAdsorbPolygons(polygon);
        polygon.on('dblclick', () => {
            polyEditor.setTarget(polygon);
            polyEditor.open();
        })
        setTimeout(function () {
            $.ajax({
                type: 'GET',
                url: SERVER + "xiaofangcheNewShu",
                success: function (data) {
                    compute(data.data);
                }
            });
        }, 100)
    })

    polyEditor.on('adjust', function (data) {
        setTimeout(function () {
            $.ajax({
                type: 'GET',
                url: SERVER + "xiaofangcheNewShu",
                success: function (data) {
                    compute(data.data);
                }
            });
        }, 100)
    })

    function createPolygon() {
        polyEditor.close();
        if (polygon) {
            map.remove(polygon);
        }
        polyEditor.setTarget();
        polyEditor.open();
    }

    function quxiaoxuanze() {
        polyEditor.close();
        if (polygon) {
            map.remove(polygon);
        }
    }

    function shujutongji() {
        polyEditor.setTarget(polygon);
        polyEditor.open();
        if ((ids.length === 0)) {
            log.info('该区域内没有消防车');
        } else {
            openMessage1(1);
        }
    }

    //控制地图边界
    var mybounds = new AMap.Bounds([ditujingdu - 8, dituweidu - 4], [ditujingdu + 8, dituweidu + 4]);
    map.setLimitBounds(mybounds);

    //本页面使用多边形选中的消防车id的List
    var ids = [];
    //子页面使用多边形选中的消防车id的List
    var xiaofangcheIdList = [];

    //统计编选中区域里面的消防车数据
    function compute(data) {
        xiaofangcheIdList = [];
        var xiaofangcheshuliang = 0;
        var shuiliang = 0;
        var paomoliang = 0;
        var zhuangbeizongjianshu = 0;
        var zongrenshu = 0;
        $("#td1").html("");
        $("#td2").html("");
        $("#td3").html("");
        $("#td4").html("");
        $("#td5").html("");

        for (var i = 0; i < data.length; i++) {
            if (data[i]['jingdu'] != null && data[i]['weidu'] != null && data[i]['JB'] === -1) {
                var myLngLat = new AMap.LngLat(data[i]['jingdu'], data[i]['weidu']);
                if (polygon.contains(myLngLat)) {
                    let id = {};
                    id.xiaofangcheId = data[i].cheId;
                    xiaofangcheIdList.push(id);
                }
            }
        }
        ids = [];
        for (var i = 0; i < xiaofangcheIdList.length; i++) {
            ids.push(xiaofangcheIdList[i].xiaofangcheId)
        }
        //实时显示多边形圈选区域内容
        // if (ids.length === 0) {
        //     console.log(0)
        // } else {
        //     $.ajax({
        //         type: "POST",
        //         url: SERVER + "zuozhanyingyong/shujutongji",
        //         async: false,
        //         data: JSON.stringify(ids),
        //         dataType: 'json',
        //         contentType: "application/json",
        //         success: function (data) {
        //             var carData = data.data;
        //             if (carData !== null && carData !== '' && carData !== "undefined" && carData !== 0) {
        //                 xiaofangcheshuliang = carData.xiaofangcheshu;
        //                 paomoliang = Number(carData.zongpaomoliang);
        //                 shuiliang = Number(carData.zongshuiliang);
        //                 zhuangbeizongjianshu = carData.qicaishu;
        //                 zongrenshu = carData.xiaofangyuanshu;
        //                 $("#td1").append(xiaofangcheshuliang + "辆");
        //                 $("#td2").append(shuiliang + "吨");
        //                 $("#td3").append(paomoliang + "吨");
        //                 $("#td4").append(zhuangbeizongjianshu + "件");
        //                 $("#td5").append(zongrenshu + "人");
        //             }
        //         }
        //
        //     })
        // }
    }

    //给子页面提供消防车idList的方法
    function getidList() {
        return xiaofangcheIdList;
    }

    //初始化左侧树
    function zTreeReady() {
        $.ajax({
            type: 'GET',
            url: SERVER + "xiaofangcheNewShu",
            success: function (data) {
                var zNodes = [];
                for(var i = 0;i<data.data.length;i++){
                    if(data.data[i].JB !== -1){
                        zNodes.push(data.data[i])
                    }
                }
                // zNodes = data.data;
                for (var i = 0; i < zNodes.length; i++) {
                    zNodes[i].icon = "../images/jigou.png";
                }
                var t = $("#treeDemo");
                t = $.fn.zTree.init(t, setting, zNodes);
                treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                var nodes = treeObj.getNodes();
                if (nodes.length > 0) {
                    for (var i = 0; i < nodes.length; i++) {
                        treeObj.expandNode(nodes[i], true, false, false);
                    }
                }
            }
        });
    };

    //点击节点并获取此节点ID
    // function zTreeBeforeClick(treeId, treeNode, clickFlag) {
    //     $.ajax({
    //         type: 'GET',
    //         url: SERVER + "xiaofangcheNewShu",
    //         success: function (data) {
    //             zNodes = data.data;
    //             for (var i = 0; i < zNodes.length; i++) {
    //                 if (data.data[i].JB === 3) {
    //                     zNodes[i].icon = "../images/jigou.png";
    //                 }
    //             }
    //             var t = $("#treeDemo");
    //             t = $.fn.zTree.init(t, setting, zNodes);
    //             treeObj = $.fn.zTree.getZTreeObj("treeDemo");
    //             //展开点击节点的父节点
    //             treeObj.expandNode(treeObj.getNodeByParam("id", treeNode.getParentNode().id), true, false);
    //         }
    //     });
    // };

    var treeNodeClick = null;

    //条件查询警情
    function getJingqing () {
        jingqingpoints=[];
        $.ajax({
            type: "get",
            url: SERVER + "getChujingjiluNew?chujingleixingList="+jingqingleixing+"&jigoudaimaList="+jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].dizhijingdu && data.data.content[i].dizhiweidu) {
                        lnglat.push(data.data.content[i].dizhijingdu)
                        lnglat.push(data.data.content[i].dizhiweidu)
                    }
                    data.data.content[i].lnglat = lnglat;
                    jingqingpoints.push(data.data.content[i]);
                }
            }
        })
    }

    //条件查询水源
    function getShuiyuan () {
        shuiyuanpoints=[];
        $.ajax({
            type: "get",
            url: SERVER + "chaxunshuiyuanliebiaoNew?shuiyuanleixingList=" + shuiyuanleixing + "&jigoudaimaList=" + jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].dizhijingdu && data.data.content[i].dizhiweidu) {
                        lnglat.push(data.data.content[i].dizhijingdu)
                        lnglat.push(data.data.content[i].dizhiweidu)
                    }
                    data.data.content[i].lnglat = lnglat;
                    shuiyuanpoints.push(data.data.content[i]);
                }
            }
        })
    }

    //条件查询重点单位
    function getDanWei () {
        zhongdiandanweipoints=[];
        $.ajax({
            type: "get",
            url: SERVER + "zhongdiandanwei/findAllNew?leixingList="+zhongdiandanweileixing+"&jigoudaimaList="+jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].jingweidu) {
                        lnglat.push(data.data.content[i].jingweidu.split(',')[0])
                        lnglat.push(data.data.content[i].jingweidu.split(',')[1])
                    }
                    data.data.content[i].lnglat = lnglat;
                    zhongdiandanweipoints.push(data.data.content[i]);
                }
            }
        });

    }

    //条件查询消防车
    function getXiaofangche () {
        var dest = [];
        points=[];
        $.ajax({
            type: "POST",
            url: SERVER + "huoquXFCshishiweizhiLiebiaoNew?leixingList=" + xiaofangcheleixing + "&jigoudaimalist=" + jigoudaimaiList,
            async: false,
            success: function (data) {
                for (var i = 0; i < data.data.length; i++) {
                    if (data.data[i].tbXiaofangcheweizhi.jingdu != null && data.data[i].tbXiaofangcheweizhi.weidu != null) {
                        var lnglat = [];
                        lnglat.push("" + data.data[i].tbXiaofangcheweizhi.jingdu + "");
                        lnglat.push("" + data.data[i].tbXiaofangcheweizhi.weidu + "");
                        var obj = {};
                        obj['jingdu'] = data.data[i].tbXiaofangcheweizhi.jingdu;
                        obj['weidu'] = parseInt(data.data[i].tbXiaofangcheweizhi.weidu * 1000) / 1000;
                        obj['lnglat'] = lnglat;
                        obj['chepaihaoma'] = data.data[i].tbXiaofangcheweizhi.chepaihaoma;
                        //显示的参数
                        obj['cheliangleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;
                        obj['suoshujigou'] = data.data[i].tbXiaofangcheweizhi.jigoumingcheng;
                        obj['weizhishijian'] = data.data[i].tbXiaofangcheweizhi.gengxinshijian;
                        obj['chujingzhuangtai'] = data.data[i].tbXiaofangcheNew.chujingzhuangtai;
                        obj['xiaofangchezhuangtai'] = data.data[i].tbXiaofangcheNew.xiaofangchezhuangtai;
                        obj['id'] = data.data[i].tbXiaofangcheNew.id;

                        obj['xiaofangcheleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;
                        obj['xiaofangcheleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;

                        obj['shifoushenyangsuocheliang'] = data.data[i].tbXiaofangcheNew.shifoushenyangsuocheliang;
                        if (data.data[i].tbCedpxx !== null) {
                            obj['dipanxinxi'] = data.data[i].tbCedpxx.fvcptime;
                            if (data.data[i].tbCedpxx['runningspeed'] != -300 && data.data[i].tbCedpxx['runningspeed'] != "-300") {
                                obj['sudu'] = data.data[i].tbCedpxx['runningspeed'];
                            } else {
                                obj['sudu'] = "";
                            }
                            if (data.data[i].tbCedpxx['tachometer'] != -300 && data.data[i].tbCedpxx['tachometer'] != "-300") {
                                obj['fadongjizhuansu'] = data.data[i].tbCedpxx['tachometer'];
                            } else {
                                obj['fadongjizhuansu'] = "";
                            }
                            if (data.data[i].tbCedpxx['oilmass'] != -300 && data.data[i].tbCedpxx['oilmass'] != "-300") {
                                obj['shengyuranyou'] = data.data[i].tbCedpxx['oilmass'];
                            } else {
                                obj['shengyuranyou'] = "";
                            }
                            if (data.data[i].tbCedpxx['mileage'] != -300 && data.data[i].tbCedpxx['mileage'] != "-300") {
                                obj['zonglicheng'] = data.data[i].tbCedpxx['mileage'];
                            } else {
                                obj['zonglicheng'] = "";
                            }
                            if (data.data[i].tbCedpxx['coulombmeter'] != -300 && data.data[i].tbCedpxx['coulombmeter'] != "-300") {
                                obj['xudianchidianya'] = data.data[i].tbCedpxx['coulombmeter'];
                            } else {
                                obj['xudianchidianya'] = "";
                            }
                            if (data.data[i].tbCedpxx['engoiltemp'] != -300 && data.data[i].tbCedpxx['engoiltemp'] != "-300") {
                                obj['jiyouwendu'] = data.data[i].tbCedpxx['engoiltemp'];
                            } else {
                                obj['jiyouwendu'] = "";
                            }
                        }
                        if (data.data[i].tbCeszxx !== null) {
                            obj['shangzhuangxinxi'] = data.data[i].tbCeszxx['fvaptime'];
                            if (data.data[i].tbCeszxx['hydriawaterlevel'] != -300 && data.data[i].tbCeszxx['hydriawaterlevel'] != "-300") {
                                obj['shuiguanyewei'] = data.data[i].tbCeszxx['hydriawaterlevel'];
                            } else {
                                obj['shuiguanyewei'] = "";
                            }
                            if (data.data[i].tbCeszxx['foamlevel'] != -300 && data.data[i].tbCeszxx['foamlevel'] != "-300") {
                                obj['apaomoguan'] = data.data[i].tbCeszxx['foamlevel'];
                            } else {
                                obj['apaomoguan'] = "";
                            }
                            obj['bpaomoguan'] = '';
                            if (data.data[i].tbCeszxx['pumpexitpressure'] != -300 && data.data[i].tbCeszxx['pumpexitpressure'] != "-300") {
                                obj['xiaofangshuanyali'] = data.data[i].tbCeszxx['pumpexitpressure'];
                            } else {
                                obj['xiaofangshuanyali'] = "";
                            }
                        }
                        points.push(obj);
                    }
                }
                //如果消防车经纬度差别很小，手动做一些纬度偏移+0.001
                var map = {};
                dest.push(points[0]);
                for (var i = 0; i < points.length; i++) {
                    var ai = points[i];
                    // var dj = points[i + 1];
                    // if (i < points.length - 1) {
                    //     if (Math.abs(dj.weidu - ai.weidu) < 0.001 && Math.abs(dj.jingdu - ai.jingdu) < 0.001) {
                    //         dj.weidu = ai.weidu + 0.0001;
                    //     }
                    //     dest.push(dj);
                    // }
                    map[ai.weidu] = ai.weidu;
                }
                for (var i = 0; i < dest.length; i++) {
                    var lnglat = [];
                    lnglat.push("" + dest[i]['jingdu'] + "");
                    lnglat.push("" + dest[i]['weidu'] + "");
                    dest[i]['lnglat'] = lnglat;
                }
                for (var i = 0; i < dest.length; i++) {
                    var lnglat = [];
                    lnglat.push("" + dest[i]['jingdu'] + "");
                    lnglat.push("" + dest[i]['weidu'] + "");
                    dest[i]['lnglat'] = lnglat;
                }
                addCluster()
            }
        });
    }

    //刷新地图信息
    function getDitu() {
        var dest = [];
        points=[];
        zhongdiandanweipoints=[];
        jingqingpoints=[];
        shuiyuanpoints=[];
        $.ajax({
            type: "get",
            url: SERVER + "zhongdiandanwei/findAllNew?leixingList="+zhongdiandanweileixing+"&jigoudaimaList="+jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].jingweidu) {
                        lnglat.push(data.data.content[i].jingweidu.split(',')[0])
                        lnglat.push(data.data.content[i].jingweidu.split(',')[1])
                    }
                    data.data.content[i].lnglat = lnglat;
                    zhongdiandanweipoints.push(data.data.content[i]);
                }
            }
        });
        $.ajax({
            type: "get",
            url: SERVER + "getChujingjiluNew?chujingleixingList="+jingqingleixing+"&jigoudaimaList="+jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].dizhijingdu && data.data.content[i].dizhiweidu) {
                        lnglat.push(data.data.content[i].dizhijingdu)
                        lnglat.push(data.data.content[i].dizhiweidu)
                    }
                    data.data.content[i].lnglat = lnglat;
                    jingqingpoints.push(data.data.content[i]);
                }
            }
        })
        $.ajax({
            type: "get",
            url: SERVER + "chaxunshuiyuanliebiaoNew?shuiyuanleixingList=" + shuiyuanleixing + "&jigoudaimaList=" + jigoudaimaiList,
            async: false,
            success: function (data) {
                if (data.status != 0) {
                    log.info(data.message);
                    return;
                }
                for (let i = 0; i < data.data.content.length; i++) {
                    let lnglat = [];
                    if (data.data.content[i].dizhijingdu && data.data.content[i].dizhiweidu) {
                        lnglat.push(data.data.content[i].dizhijingdu)
                        lnglat.push(data.data.content[i].dizhiweidu)
                    }
                    data.data.content[i].lnglat = lnglat;
                    shuiyuanpoints.push(data.data.content[i]);
                }
            }
        })
        $.ajax({
            type: "POST",
            url: SERVER + "huoquXFCshishiweizhiLiebiaoNew?leixingList=" + xiaofangcheleixing + "&jigoudaimalist=" + jigoudaimaiList,
            async: false,
            success: function (data) {
                for (var i = 0; i < data.data.length; i++) {
                    if (data.data[i].tbXiaofangcheweizhi.jingdu != null && data.data[i].tbXiaofangcheweizhi.weidu != null) {
                        var lnglat = [];
                        lnglat.push("" + data.data[i].tbXiaofangcheweizhi.jingdu + "");
                        lnglat.push("" + data.data[i].tbXiaofangcheweizhi.weidu + "");
                        var obj = {};
                        obj['jingdu'] = data.data[i].tbXiaofangcheweizhi.jingdu;
                        obj['weidu'] = parseInt(data.data[i].tbXiaofangcheweizhi.weidu * 1000) / 1000;
                        obj['lnglat'] = lnglat;
                        obj['chepaihaoma'] = data.data[i].tbXiaofangcheweizhi.chepaihaoma;
                        //显示的参数
                        obj['cheliangleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;
                        obj['suoshujigou'] = data.data[i].tbXiaofangcheweizhi.jigoumingcheng;
                        obj['weizhishijian'] = data.data[i].tbXiaofangcheweizhi.gengxinshijian;
                        obj['chujingzhuangtai'] = data.data[i].tbXiaofangcheNew.chujingzhuangtai;
                        obj['xiaofangchezhuangtai'] = data.data[i].tbXiaofangcheNew.xiaofangchezhuangtai;
                        obj['id'] = data.data[i].tbXiaofangcheNew.id;

                        obj['xiaofangcheleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;
                        obj['xiaofangcheleixing'] = data.data[i].tbXiaofangcheweizhi.xiaofangcheleixing;

                        obj['shifoushenyangsuocheliang'] = data.data[i].tbXiaofangcheNew.shifoushenyangsuocheliang;
                        if (data.data[i].tbCedpxx !== null) {
                            obj['dipanxinxi'] = data.data[i].tbCedpxx.fvcptime;
                            if (data.data[i].tbCedpxx['runningspeed'] != -300 && data.data[i].tbCedpxx['runningspeed'] != "-300") {
                                obj['sudu'] = data.data[i].tbCedpxx['runningspeed'];
                            } else {
                                obj['sudu'] = "";
                            }
                            if (data.data[i].tbCedpxx['tachometer'] != -300 && data.data[i].tbCedpxx['tachometer'] != "-300") {
                                obj['fadongjizhuansu'] = data.data[i].tbCedpxx['tachometer'];
                            } else {
                                obj['fadongjizhuansu'] = "";
                            }
                            if (data.data[i].tbCedpxx['oilmass'] != -300 && data.data[i].tbCedpxx['oilmass'] != "-300") {
                                obj['shengyuranyou'] = data.data[i].tbCedpxx['oilmass'];
                            } else {
                                obj['shengyuranyou'] = "";
                            }
                            if (data.data[i].tbCedpxx['mileage'] != -300 && data.data[i].tbCedpxx['mileage'] != "-300") {
                                obj['zonglicheng'] = data.data[i].tbCedpxx['mileage'];
                            } else {
                                obj['zonglicheng'] = "";
                            }
                            if (data.data[i].tbCedpxx['coulombmeter'] != -300 && data.data[i].tbCedpxx['coulombmeter'] != "-300") {
                                obj['xudianchidianya'] = data.data[i].tbCedpxx['coulombmeter'];
                            } else {
                                obj['xudianchidianya'] = "";
                            }
                            if (data.data[i].tbCedpxx['engoiltemp'] != -300 && data.data[i].tbCedpxx['engoiltemp'] != "-300") {
                                obj['jiyouwendu'] = data.data[i].tbCedpxx['engoiltemp'];
                            } else {
                                obj['jiyouwendu'] = "";
                            }
                        }
                        if (data.data[i].tbCeszxx !== null) {
                            obj['shangzhuangxinxi'] = data.data[i].tbCeszxx['fvaptime'];
                            if (data.data[i].tbCeszxx['hydriawaterlevel'] != -300 && data.data[i].tbCeszxx['hydriawaterlevel'] != "-300") {
                                obj['shuiguanyewei'] = data.data[i].tbCeszxx['hydriawaterlevel'];
                            } else {
                                obj['shuiguanyewei'] = "";
                            }
                            if (data.data[i].tbCeszxx['foamlevel'] != -300 && data.data[i].tbCeszxx['foamlevel'] != "-300") {
                                obj['apaomoguan'] = data.data[i].tbCeszxx['foamlevel'];
                            } else {
                                obj['apaomoguan'] = "";
                            }
                            obj['bpaomoguan'] = '';
                            if (data.data[i].tbCeszxx['pumpexitpressure'] != -300 && data.data[i].tbCeszxx['pumpexitpressure'] != "-300") {
                                obj['xiaofangshuanyali'] = data.data[i].tbCeszxx['pumpexitpressure'];
                            } else {
                                obj['xiaofangshuanyali'] = "";
                            }
                        }
                        points.push(obj);
                    }
                }
                //如果消防车经纬度差别很小，手动做一些纬度偏移+0.001
                var map = {};
                dest.push(points[0]);
                for (var i = 0; i < points.length; i++) {
                    var ai = points[i];
                    // var dj = points[i + 1];
                    // if (i < points.length - 1) {
                    //     if (Math.abs(dj.weidu - ai.weidu) < 0.001 && Math.abs(dj.jingdu - ai.jingdu) < 0.001) {
                    //         dj.weidu = ai.weidu + 0.0001;
                    //     }
                    //     dest.push(dj);
                    // }
                    map[ai.weidu] = ai.weidu;
                }
                for (var i = 0; i < dest.length; i++) {
                    var lnglat = [];
                    lnglat.push("" + dest[i]['jingdu'] + "");
                    lnglat.push("" + dest[i]['weidu'] + "");
                    dest[i]['lnglat'] = lnglat;
                }
                for (var i = 0; i < dest.length; i++) {
                    var lnglat = [];
                    lnglat.push("" + dest[i]['jingdu'] + "");
                    lnglat.push("" + dest[i]['weidu'] + "");
                    dest[i]['lnglat'] = lnglat;
                }
                addCluster()
            }
        });
    }

    function openMessage(id) {
        layer.open({
            type: 2,
            title: '实时信息',
            area: ['1000px', '580px'],
            shadeClose: true,
            content: "./amapIframe.html?id=" + id,
        });
    }

    //消防车轨迹信息弹出框
    function openMessage2(chepaihaoma) {
        layer.open({
            type: 2,
            title: ['轨迹信息', 'text-align:center'],
            area: ['1200px', '600px'],
            shadeClose: true,
            content: "./amapLink.html?chepaihaoma=" + chepaihaoma,
        });
    }

    //消防车统计信息弹出框
    function openMessage1(id) {
        layer.open({
            type: 2,
            title: ['消防车信息', 'text-align:center'],
            area: ['1200px', '600px'],
            shadeClose: true,
            content: "./tankuang.html?id=" + id,
        });
    }

    //未点聚合前的样式
    var _renderMarker = function (context) {
        var content = '<div style="background: url(../images/baotingxiaofangche.png); height: 40px; width: 60px; font-size:14px; font-weight:bold;"></div>';
        if (context.data && context.data[0] && context.data[0].xiaofangchezhuangtai === '报停') {
            content = '<div style="background: url(../images/baotingxiaofangche.png); height: 40px; width: 60px; font-size:14px; font-weight:bold;"></div>';
        } else {
            if (context.data && context.data[0] && context.data[0].chujingzhuangtai === '在营') {
                content = '<div style="background: url(../images/zaiyingxiaofangche.png); height: 40px; width: 60px; font-size:14px; font-weight:bold;"></div>';
            } else {
                content = '<div style="background: url(../images/chuyingxiaofangche.png); height: 40px; width: 60px; font-size:14px; font-weight:bold;"></div>';
            }
        }
        var offset = new AMap.Pixel(-15, -15);
        context.marker.setContent(content)
        context.marker.setOffset(offset);
        var points;
        if (context.data && context.data[0]) {
            points = context.data[0];
        }
        var markerjwd = context.marker.getPosition();
        infoWindow = new AMap.InfoWindow({
            isCustom: false,
            //	        offset: new AMap.Pixel(0, -31),
            content: ""
        });
        if (context.marker !== undefined) {
            context.marker.on('dblclick', function (e) {
                if (points.shifoushenyangsuocheliang === '是') {
                    infoWindow.setContent(
                        "<div style='box-sizing: content-box; width: 440px; height: 340px; position: static; left: 16px; top: 16px; z-index: 10; overflow: hidden;'>"
                        + "<div class='BMap_bubble_title' style='display: none; overflow: hidden; height: auto; line-height: 24px; white-space: nowrap; width: auto;'></div>"
                        + "<div class='BMap_bubble_content' style='width: auto; height: auto;'>"
                        + "<div class='clxx_box'>"
                        + "<span>车牌号码：</span>"
                        + "<span>" + points.chepaihaoma + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
                        + "<span>车辆类型：</span>"
                        + "<span>" + points.cheliangleixing + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
                        + "<span>所属机构：</span>"
                        + "<span>" + points.suoshujigou + "</span>"
                        + "</div>"
                        + "<div class='aaa'>"
                        + "<span>底盘信息：</span>"
                        + "<span>" + points.dipanxinxi + "</span>"
                        + "</div>"
                        + "<div class='detail_box'>"
                        + "<table>"
                        + "<tbody>"
                        + "<tr>"
                        + "<td>速度(km/h):</td>"
                        + "<td class='blue'>" + points.sudu + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>发动机转速(r/min):</td>"
                        + "<td class='blue'>" + points.fadongjizhuansu + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>剩余燃油百分比(%):</td>"
                        + "<td class='blue'>" + points.shengyuranyou + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "</tr>"
                        + "<tr>"
                        + "<td>总里程(km):</td>"
                        + "<td class='blue'>" + points.zonglicheng + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>蓄电池电压(V):</td>"
                        + "<td class='blue'>" + points.xudianchidianya + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>机油温度(℃):</td>"
                        + "<td class='blue'>" + points.jiyouwendu + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "</tr>"
                        + "</tbody>"
                        + "</table>"
                        + "</div>"
                        + "<div class='aaa'>"
                        + "<span style='color:#ff8800'>上装信息：</span>"
                        + "<span style='color:#ff8800'>" + points.shangzhuangxinxi + "</span>"
                        + "</div>"
                        + "<div class='szxx_box'>"
                        + "<table>"
                        + "<tbody>"
                        + "<tr>"
                        + "<td>水罐液位(%):</td>"
                        + "<td class='blue'>" + points.shuiguanyewei + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>A类泡沫罐液位(%):</td>"
                        + "<td class='blue'>" + points.apaomoguan + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "<td>B类泡沫罐液位(%):</td>"
                        + "<td class='blue'>" + points.bpaomoguan + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "</tr>"
                        + "<tr>"
                        + "<td>消防水泵出口压力(kpa):</td>"
                        + "<td class='blue'>" + points.xiaofangshuanyali + "</td>"
                        + "<td class='bor_none' width='5'></td>"
                        + "</tr>"
                        + "</tbody>"
                        + "</table>"
                        + "</div>"
                        + "<br/>"
                        + "<div class='aaa'>"
                        + "<span style='color:#429842'>位置时间：</span>"
                        + "<span style='color:#429842'>" + points.weizhishijian + "</span>"
                        + "</div>"
                        + "<div class='aaa'>"
                        + "<a style='color:blue' onclick='openMessage(" + points.id + ")'>实时信息详情</a>"
                        + "<a style='color:blue' onclick='openMessage2(\"" + points.chepaihaoma + "\")'>轨迹信息</a>"
                        + "</div>"
                        + "</div>"
                        + "</div>"
                    );

                } else {
                    infoWindow.setContent(
                        "<div style='box-sizing: content-box; width: 300px; height: 120px; position: static; left: 16px; top: 16px; z-index: 10; overflow: hidden;'>"
                        + "<div class='BMap_bubble_title' style='display: none; overflow: hidden; height: auto; line-height: 24px; white-space: nowrap; width: auto;'></div>"
                        + "<div class='BMap_bubble_content' style='width: auto; height: auto;'>"
                        + "<div class='clxx_box'>"
                        + "<span>车牌号码：</span>"
                        + "<span>" + points.chepaihaoma + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
                        + "<span>车辆类型：</span>"
                        + "<span>" + points.cheliangleixing + "</span> &nbsp;&nbsp;&nbsp;&nbsp;"
                        + "<br/>"
                        + "<span>所属机构：</span>"
                        + "<span>" + points.suoshujigou + "</span> &nbsp;&nbsp;|&nbsp;&nbsp;"
                        + "<span>出警状态：</span>"
                        + "<span>" + points.chujingzhuangtai + "</span> &nbsp;&nbsp;&nbsp;&nbsp;"
                        + "<br/>"
                        + "<span>消防车状态：</span>"
                        + "<span>" + points.xiaofangchezhuangtai + "</span>"
                        + "</div>"
                        + "<div class='aaa'>"
                        + "<span style='color:#429842'>位置时间：</span>"
                        + "<span style='color:#429842'>" + moment(points.weizhishijian).format('YYYY-MM-DD HH:mm:ss') + "</span>"
                        + "</div>"
                        + "<div class='aaa'>"
                        + "<a style='color:blue' onclick='openMessage2(\"" + points.chepaihaoma + "\")'>轨迹信息</a>"
                        + "</div>"
                        + "</div>"
                        + "</div>"
                    );
                }
                infoWindow.open(map, markerjwd);
            })
        }
    }

    //点聚合后的样式
    var _renderClusterMarker = function (context) {
        var count = points.length;
        // 聚合中点个数
        var clusterCount = context.count;
        var div = document.createElement('div');


        bgColor = '30,144,255',

            div.style.backgroundColor = 'rgba(' + bgColor + ',.5)';
        var size = Math.round(25 + Math.pow(clusterCount / count, 1 / 5) * 40);
        div.style.width = div.style.height = size + 'px';
        div.style.border = 'solid 1px rgba(' + bgColor + ',1)';
        div.style.borderRadius = size / 2 + 'px';
        div.innerHTML = context.count;
        div.style.lineHeight = size + 'px';
        div.style.color = '#ffffff';
        div.style.fontSize = '12px';
        div.style.textAlign = 'center';
        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
        context.marker.setContent(div);
    };

    //警情
    var _jingqingrenderMarker = function (context) {
        var content = '<div style="background-color: rgba(220,20,60,.9); height: 18px; width: 18px; border: 1px solid rgba(255,255,178,1); border-radius: 12px; box-shadow: rgba(0, 0, 0, 1) 0px 0px 3px;"></div>';
        var offset = new AMap.Pixel(-9, -9);
        context.marker.setContent(content);
        context.marker.setOffset(offset);
        var points;
        if (context.data && context.data[0]) {
            points = context.data[0];
        }
        var markerjwd = context.marker.getPosition();
        infoWindow = new AMap.InfoWindow({
            isCustom: false,
            //	        offset: new AMap.Pixel(0, -31),
            content: ""
        });
        if (context.marker !== undefined) {
            context.marker.on('dblclick', function (e) {
                infoWindow.setContent(
                    "<div style='box-sizing: content-box;z-index: 10; overflow: hidden;'>"
                    + "<span>灾害等级：</span>"
                    + "<span>" + points.zaihaidengji + "</span><br/>"
                    + "<span>出警类型：</span>"
                    + "<span>" + points.chujingleixing + "</span>"
                    + "</div>"
                );
                infoWindow.open(map, markerjwd);
            })
        }
    }
    //点聚合后的样式
    var _jingqingrenderClusterMarker = function (context) {
        var count = points.length;
        // 聚合中点个数
        var clusterCount = context.count;
        var div = document.createElement('div');

        bgColor = '220,20,60',

            div.style.backgroundColor = 'rgba(' + bgColor + ',.5)';
        var size = Math.round(25 + Math.pow(clusterCount / count, 1 / 5) * 40);
        div.style.width = div.style.height = size + 'px';
        div.style.border = 'solid 1px rgba(' + bgColor + ',1)';
        div.style.borderRadius = size / 2 + 'px';
        div.innerHTML = context.count;
        div.style.lineHeight = size + 'px';
        div.style.color = '#ffffff';
        div.style.fontSize = '12px';
        div.style.textAlign = 'center';
        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
        context.marker.setContent(div);
    };

    //水源
    var _shuiyuanrenderMarker = function (context) {
        var content = '<div style="background-color: hsla(180, 100%, 50%, 0.3); height: 18px; width: 18px; border: 1px solid hsl(180, 100%, 40%); border-radius: 12px; box-shadow: hsl(180, 100%, 50%) 0px 0px 3px;"></div>';
        var offset = new AMap.Pixel(-9, -9);
        context.marker.setContent(content)
        context.marker.setOffset(offset);
        var points;
        if (context.data && context.data[0]) {
            points = context.data[0];
        }
        var markerjwd = context.marker.getPosition();
        infoWindow = new AMap.InfoWindow({
            isCustom: false,
            //	        offset: new AMap.Pixel(0, -31),
            content: ""
        });
        if (context.marker !== undefined) {
            context.marker.on('dblclick', function (e) {
                infoWindow.setContent(
                    "<div style='box-sizing: content-box;z-index: 10; overflow: hidden;'>"
                    + "<span>水源地址：</span>"
                    + "<span>" + points.dizhimiaoshu + "</span><br/>"
                    + "<span>水源类型：</span>"
                    + "<span>" + points.leixing + "</span>"
                    + "</div>"
                );
                infoWindow.open(map, markerjwd);
            })
        }
    }

    var _shuiyuanrenderClusterMarker = function (context) {
        var count = points.length;
        // 聚合中点个数
        var clusterCount = context.count;
        var div = document.createElement('div');

        bgColor = '14,276,889',

            div.style.backgroundColor = 'rgba(' + bgColor + ',.5)';
        var size = Math.round(25 + Math.pow(clusterCount / count, 1 / 5) * 40);
        div.style.width = div.style.height = size + 'px';
        div.style.border = 'solid 1px rgba(' + bgColor + ',1)';
        div.style.borderRadius = size / 2 + 'px';
        div.innerHTML = context.count;
        div.style.lineHeight = size + 'px';
        div.style.color = '#ffffff';
        div.style.fontSize = '12px';
        div.style.textAlign = 'center';
        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
        context.marker.setContent(div);
    };


    //重点单位
    var _zhongdiandanweirenderMarker = function (context) {
        var points;
        if (context.data && context.data[0]) {
            points = context.data[0];
        }
        var markerjwd = context.marker.getPosition();
        infoWindow = new AMap.InfoWindow({
            isCustom: false,
            //	        offset: new AMap.Pixel(0, -31),
            content: ""
        });
        if (context.marker !== undefined) {
            context.marker.on('dblclick', function (e) {
                infoWindow.setContent(
                    "<div style='box-sizing: content-box;z-index: 10; overflow: hidden;'>"
                    + "<span>重点单位地址：</span>"
                    + "<span>" + points.dizhi + "</span><br/>"
                    + "<span>重点单位类型：</span>"
                    + "<span>" + points.leixing + "</span>"
                    + "</div>"
                );
                infoWindow.open(map, markerjwd);
            })
        }
    }

    //点聚合（未启用）
    function addCluster(tag) {
        if (cluster) {
            cluster.setMap(null);
        }
        if (zhongdiandanweicluster) {
            zhongdiandanweicluster.setMap(null);
        }
        if (jingqingcluster) {
            jingqingcluster.setMap(null);
        }
        if (shuiyuancluster) {
            shuiyuancluster.setMap(null);
        }

        cluster = new AMap.MarkerCluster(map, points, {
            gridSize: 80, // 设置网格像素大小
            renderClusterMarker: _renderClusterMarker, // 自定义聚合点样式
            renderMarker: _renderMarker, // 自定义非聚合点样式,
        });
        zhongdiandanweicluster = new AMap.MarkerCluster(map, zhongdiandanweipoints, {
            gridSize: 80, // 设置网格像素大小
            renderMarker: _zhongdiandanweirenderMarker, // 自定义非聚合点样式,
        });
        jingqingcluster = new AMap.MarkerCluster(map, jingqingpoints, {
            gridSize: 80, // 设置网格像素大小
            renderClusterMarker: _jingqingrenderClusterMarker, // 自定义聚合点样式
            renderMarker: _jingqingrenderMarker, // 自定义非聚合点样式,
        });
        shuiyuancluster = new AMap.MarkerCluster(map, shuiyuanpoints, {
            gridSize: 80, // 设置网格像素大小
            renderClusterMarker: _shuiyuanrenderClusterMarker, // 自定义聚合点样式
            renderMarker: _shuiyuanrenderMarker, // 自定义非聚合点样式,
        });
    }

    //5 秒刷新
    // window.setInterval(refresh, 50000);

    function refresh() {
        points = [];
        lnglat = [];
        getDitu();
    }

    //根据组织机构经纬度画出电子围栏
    function getDianziweilan() {
        var jigoumingcheng = sessionStorage.getItem("jigoumingcheng");
        $.ajax({
            url: SERVER + "zuzhijigouXiangqingJgmc?jigoumingcheng=" + jigoumingcheng,
            async: false,
            success: function (data) {
                if (data.data['jingdu'] != 0 && data.data['weidu'] != 0 && data.data['dianziweilanbanjing'] != 0) {
                    var circle2 = new AMap.Circle({
                        center: new AMap.LngLat(data.data['jingdu'], data.data['weidu']),// 圆心位置
                        radius: data.data['dianziweilanbanjing'], //半径
                        strokeColor: "#D75553", //线颜色
                        strokeOpacity: 1, //线透明度
                        strokeWeight: 3, //线粗细度
                        fillColor: "#1791fc", //填充颜色
                        fillOpacity: 0.05//填充透明度
                    });
                    circle2.setMap(map);
                } else {

                }
            }
        });
        getDitu();
    }

</script>
</body>
</html>
