<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
	<title>人员GPS轨迹</title>
	<script type="text/javascript" src="common/jquery.min.js"></script>
	<script type="text/javascript" src="common/common.js"></script>
	<link rel="stylesheet" type="text/css" href="common/theme/default/gis.css" />
	<style type="text/css">
		#container {
			width: 100%;
			height: 100%;
			margin: 0px;
		}
	</style>
</head>

<body>
<div id="container"></div>
<script type="text/javascript" src='//webapi.amap.com/maps?v=1.4.9&key=4e1808829fb90fb841c9352870fdae9f'></script>
<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
<script type="text/javascript">
	var map;
	$(document).ready(function(){
		getDianziweilan();
	});

	function getDianziweilan() {
		var jigoumingcheng = sessionStorage.getItem("jigoumingcheng");
		$.ajax({
			url:SERVER+"zuzhijigouXiangqingJgmc?jigoumingcheng="+jigoumingcheng,
			async:false,
			success:function(data) {
				if (data.data['jingdu'] != 0 && data.data['weidu'] != 0 && data.data['dianziweilanbanjing'] != 0) {
					map = new AMap.Map("container", {
						resizeEnable: true,
						center:[data.data['jingdu'],data.data['weidu']],
						zoom: 16,
						showIndoorMap: false,
						zooms:[8,19]
					});
					var mybounds = new AMap.Bounds([data.data['jingdu']-4, data.data['weidu']-2], [data.data['jingdu']+4, data.data['weidu']+2]);
					map.setBounds(mybounds);
					var bounds = map.getBounds();
					map.setLimitBounds(bounds);

					var circle = new AMap.Circle({
						center: new AMap.LngLat(data.data['jingdu'], data.data['weidu']),// 圆心位置
						radius: data.data['dianziweilanbanjing'], //半径
						strokeColor: "#D75553", //线颜色
						strokeOpacity: 1, //线透明度
						strokeWeight: 3, //线粗细度
						fillColor: "#1791fc", //填充颜色
						fillOpacity: 0.05//填充透明度
					});
					circle.setMap(map);
				} else {
					map = new AMap.Map("container", {
						resizeEnable: true,
						center:[122.118755,37.506695],
						zoom: 16,
						zooms:[8,19]
					});
					var mybounds = new AMap.Bounds([122.118755-3, 37.506695-4], [122.118755+3, 37.506695+4]);
					map.setBounds(mybounds);
					var bounds = map.getBounds();
					map.setLimitBounds(bounds);
				}
			}
		});
	}

	var navg1 = null;
	function startRun(suosubumen, name, starttime, endtime) {
		console.log(navg1);
		if (navg1 != null) {
			navg1.destroy();
		}
		var obj = {};
		obj.starttime = starttime;
		obj.endtime = endtime;
		obj.suosubumen = suosubumen;
		obj.name = name;
		$.ajax({
			type: "POST",
			url: SERVER + "renyuanweizhilishiliebiao",
			async: false,
			data : JSON.stringify(obj),
			dataType : 'json',
			contentType : "application/json",
			success: function(data) {
				if (data.data == null || data.data.length == 0) {
					alert('当前时间段无相关人员轨迹');
					return;
				} else {
					//绘制轨迹
					if (window.pathSimplifierIns) {
						//通过该方法清空上次传入的轨迹
						pathSimplifierIns.setData([]);
					}
					AMapUI.load(['ui/misc/PathSimplifier', 'lib/$'], function(PathSimplifier, $) {
						if (!PathSimplifier.supportCanvas) {
							alert('当前环境不支持 Canvas，无法显示人员轨迹图，建议使用Google浏览器预览');
							return;
						}
						var pathSimplifierIns = new PathSimplifier({
							zIndex: 100,
							map: map, //所属的地图实例
							getPath: function(pathData, pathIndex) {
								return pathData.path;
							},
							getHoverTitle: function(pathData, pathIndex, pointIndex) {
								return pathData.name
							},
							renderOptions: {
								renderAllPointsIfNumberBelow: -1 //绘制路线节点，如不需要可设置为-1
							}
						});
						pathSimplifierIns.clearPathNavigators();
						window.pathSimplifierIns = pathSimplifierIns;
						//绘制人员轨迹
						for (let i = 0; i < data.data.length; i++) {
							//设置数据
							if (data.data[i].gps == null || data.data[i].gps.length == 0) {

							} else {
								pathSimplifierIns.setData([{
									name: data.data[i].xingming,
									path: data.data[i].gps,
								}]);
								//对第一条线路（即索引 0）创建一个巡航器
								navg1 = pathSimplifierIns.createPathNavigator(0, {
									loop: false, //不循环播放
									speed: 1000 //巡航速度，单位千米/小时
								});
								navg1.start();
							}
						}
					});
				}
			}
		});
	}

</script>
</body>

</html>